name: Pull request validation

on:
  pull_request:
    branches:
      - main

    paths-ignore:
      - .github
      - .vscode

  push:
    branches:
      - feat-github-workflow

  workflow_dispatch: {}

defaults:
  run:
    shell: bash

env:
  node-version: 20.x
  skip-secure-feed: true # TODO: Turn this off.

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ env.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node-version }}
          cache: npm

      - if: "env.skip-secure-feed != 'true'"
        name: Enable secure feed
        run: npx https://aka.ms/EnableSecureFeed

      - run: npm clean-install

      - run: npm run bootstrap

      - run: npm run build --if-present

      # - name: Pack docker.zip
      #   run: zip -r docker.zip . -x .git

      - name: Pack ./__tests__
        run: |
          zip docker.zip -r@ <<EOF
          ./__tests__/
          ./babel-jest-config.js
          ./babel-passthru-transformer.js
          ./babel.config.json
          ./chrome.dockerfile
          ./docker-compose-wsl2.yml
          ./jest.config.js
          ./node_modules/
          ./packages/bundle/dist/
          ./packages/test/harness/
          ./packages/test/page-object/dist/
          ./serve-test.json
          ./testharness.dockerfile
          ./testharness2.dockerfile
          EOF

      - run: ls -l docker.zip

      - name: Upload Docker artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker
          path: docker.zip
          retention-days: 1

  unit-test:
    name: Unit test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ env.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node-version }}
          cache: npm

      - if: "env.skip-secure-feed != 'true'"
        name: Enable secure feed
        run: npx https://aka.ms/EnableSecureFeed

      - run: npm clean-install

      - run: npm run bootstrap

      - run: npm run build --if-present

      - name: Run jest --testPathPatterns packages/
        run: node_modules/.bin/jest --testPathPatterns packages/

  html-test:
    name: HTML test (${{ format('{0}/{1}', matrix.shard-index, matrix.shard-count) }})
    needs:
      - build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard-index: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        shard-count: [10]

    steps:
      - name: Use Node.js ${{ env.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.node-version }}

      - if: "env.skip-secure-feed != 'true'"
        name: Enable secure feed
        run: npx https://aka.ms/EnableSecureFeed

      - name: Download Docker artifact
        uses: actions/download-artifact@v3
        with:
          name: docker

      - run: unzip docker.zip

      - run: rm docker.zip

      - name: Run docker-compose build
        run: docker-compose -f docker-compose-wsl2.yml build --build-arg REGISTRY=mcr.microsoft.com/mirror/docker/library

      - name: Run docker-compose up
        run: docker-compose -f docker-compose-wsl2.yml up --detach --scale chrome=2

      - name: Run jest --shard=${{ format('{0}/{1}', matrix.shard-index, matrix.shard-count) }}
        run: |
          npx \
            --package jest@28 \
            --package @babel/plugin-transform-runtime \
            --package @babel/preset-env \
            --package @babel/preset-react \
            --package @babel/preset-typescript \
            --package babel-jest \
            jest
            --bail=20 \
            --ci \
            --coverage true \
            --forceExit \
            --logHeapUsage \
            --runInBand \
            --shard=${{ format('{0}/{1}', matrix.shard-index, matrix.shard-count) }}

      - continue-on-error: true
        name: Run docker-compose down
        run: docker-compose -f docker-compose-wsl2.yml down --rmi -all
