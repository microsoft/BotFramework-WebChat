<!doctype html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <main id="webchat"></main>
    <script type="importmap">
      {
        "imports": {
          "botframework-webchat": "/__dist__/packages/bundle/static/botframework-webchat.js",
          "botframework-webchat/component": "/__dist__/packages/bundle/static/botframework-webchat/component.js",
          "botframework-webchat/hook": "/__dist__/packages/bundle/static/botframework-webchat/hook.js",
          "jest-mock": "https://esm.sh/jest-mock",
          "react": "https://esm.sh/react@18",
          "react-dictate-button": "https://esm.sh/react-dictate-button",
          "react-dictate-button/": "https://esm.sh/react-dictate-button/",
          "react-dom": "https://esm.sh/react-dom@18",
          "react-dom/": "https://esm.sh/react-dom@18/"
        }
      }
    </script>
    <script type="module">
      import '/test-harness.mjs';
      import '/test-page-object.mjs';

      import { createStoreWithOptions, testIds } from 'botframework-webchat';
      import { useSendBoxSpeechInterimsVisible } from 'botframework-webchat/hook';
      import createRenderHook from '/assets/esm/createRenderHook.js';
      import {
        actSpeak,
        createWebSpeechPonyfill,
        sendMessageViaMicrophone
      } from '../../speech/js/speechPageObjects.js';

      const { createDirectLineEmulator } = window.testHelpers;

      window.WebChat = { createStoreWithOptions, testIds };

      run(
        async function () {
          const { directLine, store } = createDirectLineEmulator();
          const ponyfill = createWebSpeechPonyfill();
          const renderHook = createRenderHook(
            document.getElementById('webchat'),
            {
              directLine,
              store,
              webSpeechPonyfillFactory: () => ponyfill
            },
            { renderWebChat: true }
          );

          await renderHook();
          await pageConditions.uiConnected();

          const { resolveAll } = await directLine.actPostActivity(() =>
            actSpeak(ponyfill, () => sendMessageViaMicrophone(ponyfill, 'Hello, World!'))
          );

          await resolveAll();

          const [sendBoxSpeechInterimsVisible1] = await renderHook(() => useSendBoxSpeechInterimsVisible());

          expect(sendBoxSpeechInterimsVisible1).toBe(false);

          await host.click(document.querySelector(`[data-testid="${testIds.sendBoxMicrophoneButton}"]`));

          const [sendBoxSpeechInterimsVisible2] = await renderHook(() => useSendBoxSpeechInterimsVisible());

          expect(sendBoxSpeechInterimsVisible2).toBe(true);
        },
        { skipCheckAccessibility: true }
      );
    </script>
  </body>
</html>
