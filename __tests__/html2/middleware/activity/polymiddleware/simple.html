<!doctype html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.3.1"
        }
      }
    </script>
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  </head>

  <body>
    <main id="webchat"></main>
    <script type="module">
      import { createElement, memo } from 'react';

      run(async function () {
        const {
          testHelpers: { createDirectLineEmulator },
          WebChat: {
            middleware: { activityComponent, createActivityPolymiddleware }
          }
        } = window;

        const { directLine, store } = createDirectLineEmulator();

        const MyActivity = memo(function MyActivity({ render }) {
          return createElement('div', { style: { border: 'solid 2px red' } }, render({}));
        });

        const polymiddleware = [
          createActivityPolymiddleware(next => request => next(request)),
          createActivityPolymiddleware(next => request => {
            const result = next(request);

            if (!request.activity.entities) {
              return result;
            }

            expect(request.activity).toEqual(
              expect.objectContaining({
                text: 'Do you like my response?',
                type: 'message'
              })
            );

            return activityComponent(MyActivity, { render: result.render });
          })
        ];

        WebChat.renderWebChat(
          {
            directLine,
            polymiddleware,
            store
          },
          document.getElementById('webchat')
        );

        await pageConditions.uiConnected();

        await directLine.emulateIncomingActivity({
          text: 'This is the solution.\n\n\\[x - 1 = 0\\]\n\n\\[x = 1\\]',
          type: 'message'
        });

        await directLine.emulateIncomingActivity({
          entities: [
            {
              '@id': '',
              '@type': 'Message',
              additionalType: 'Feedback'
            }
          ],
          text: 'Do you like my response?',
          type: 'message'
        });

        await host.snapshot('local');
      });
    </script>
  </body>
</html>
