<!doctype html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <main id="webchat"></main>
    <script type="importmap">
      {
        "imports": {
          "botframework-webchat": "/__dist__/packages/bundle/static/botframework-webchat.js",
          "react": "/__dist__/packages/bundle/static/react.js",
          "react-dom": "/__dist__/packages/bundle/static/react-dom.js"
        }
      }
    </script>
    <script type="module">
      import '/test-harness.mjs';
      import '/test-page-object.mjs';

      import { createDirectLine, createStoreWithOptions, renderWebChat, testIds } from 'botframework-webchat';
      import { waitFor } from 'https://esm.sh/@testduet/wait-for';

      // TODO: Should find ways to eliminate this line.
      window.WebChat = { createStoreWithOptions, testIds };

      run(async function () {
        renderWebChat(
          {
            directLine: createDirectLine({ token: await testHelpers.token.fetchDirectLineToken() }),
            store: testHelpers.createStore()
          },
          document.getElementById('webchat')
        );

        await pageConditions.uiConnected();

        await pageObjects.sendMessageViaSendBox('video youtube', { waitForSend: true });

        await pageConditions.allImagesLoaded();
        await pageConditions.numActivitiesShown(2);

        // Play the video
        await new Promise(resolve => setTimeout(resolve, 4_000));
        // Originally it was as follows. But we can't do cross frame in html2.
        // await clickButton(driver, By.css('button[aria-label="Play"]'));

        await host.click(document.querySelector('iframe[src^="https://youtube.com/"]'));

        // Wait until the video complete buffered and start playing
        await new Promise(resolve => setTimeout(resolve, 4_000));

        // Pause the video
        await host.click(document.querySelector('iframe[src^="https://youtube.com/"]'));
        // Originally it was as follows. But we can't do cross frame in html2.
        // await clickButton(driver, By.css('button[data-title-no-tooltip="Pause"]'));

        // Jump back for 10 seconds, to get the buffering bar the same
        await host.sendKeys('j');

        // Wait for controls to fade in
        await new Promise(resolve => setTimeout(resolve, 500));

        // Hide the spinner, play/pause/rewind and controls
        await host.executeScriptInFrame(
          document.querySelector('iframe[src^="https://youtube.com/"]'),
          (() => {
            document.querySelector('.ytp-spinner')?.remove();
            document.querySelector('.ytp-bezel-text-hide')?.setAttribute('hidden', 'hidden');
            document.querySelector('.ytp-chrome-bottom')?.setAttribute('hidden', 'hidden');
            document.querySelector('.ytp-doubletap-ui-legacy')?.setAttribute('hidden', 'hidden');
            document.querySelector('.ytp-tooltip')?.setAttribute('hidden', 'hidden');
          }) + ''
        );

        await host.snapshot('local');
      });
    </script>
  </body>
</html>
