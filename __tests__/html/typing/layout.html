<!doctype html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
    <script crossorigin="anonymous" src="/__dist__/botframework-webchat-fluent-theme.production.min.js"></script>
    <style>
      .flair {
        border-radius: inherit;
        outline: solid 2px red;
        outline-offset: -2px;
      }

      .flair--ongoing {
        outline-color: green;
      }

      .loader {
        border-bottom: solid 4px blue;
      }
    </style>
  </head>
  <body>
    <main id="webchat"></main>
    <script type="text/babel">
      run(async function () {
        const {
          React,
          ReactDOM: { render },
          WebChat: {
            decorator: { DecoratorComposer },
            FluentThemeProvider,
            ReactWebChat
          }
        } = window; // Imports in UMD fashion.

        function Flair({ children }) {
          return <div className="flair">{children}</div>;
        }

        function FlairOngoing({ children }) {
          return <div className="flair flair--ongoing">{children}</div>;
        }

        function Loader({ children }) {
          return <div className="loader">{children}</div>;
        }

        const decoratorMiddleware = [
          init =>
            init === 'activity border' &&
            (next => request => (request.livestreamingState === 'completing' ? Flair : next(request))),
          init =>
            init === 'activity border' &&
            (next => request => (request.livestreamingState === 'preparing' ? Loader : next(request))),
          init =>
            init === 'activity border' &&
            (next => request => (request.livestreamingState === 'ongoing' ? FlairOngoing : next(request)))
        ];

        const { directLine, store } = testHelpers.createDirectLineEmulator();

        const activityStatusMiddleware = [() => () => () => false];

        const App = () => (
          <ReactWebChat activityStatusMiddleware={activityStatusMiddleware} directLine={directLine} store={store} />
        );

        render(
          <FluentThemeProvider>
            <DecoratorComposer middleware={decoratorMiddleware}>
              <App />
            </DecoratorComposer>
          </FluentThemeProvider>,
          document.getElementById('webchat')
        );

        await pageConditions.uiConnected();

        // WHEN: Informative message arrives.
        await directLine.emulateIncomingActivity({
          channelData: {
            streamSequence: 1,
            streamType: 'informative'
          },
          from: {
            id: 'u-00001',
            name: 'Bot',
            role: 'bot'
          },
          id: 't-00001',
          text: 'Searching your document library…',
          type: 'typing'
        });

        // THEN: Informative message should appear.
        await pageConditions.numActivitiesShown(1);
        await pageConditions.became(
          'informative message show up',
          () => pageElements.activityContents()[0].textContent === 'Searching your document library…\n',
          1_000
        );

        // THEN: Should show the informative message with blue bottom border.
        // THEN: Should not show typing indicator.
        await host.snapshot();

        // WHEN: Interim activity arrives.
        await directLine.emulateIncomingActivity({
          channelData: {
            streamId: 't-00001',
            streamSequence: 2,
            streamType: 'streaming'
          },
          from: {
            id: 'u-00001',
            name: 'Bot',
            role: 'bot'
          },
          id: 't-00002',
          text: 'A quick brown fox',
          type: 'typing'
        });

        // THEN: Interim activity should appear.
        await pageConditions.numActivitiesShown(1);
        await pageConditions.became(
          'interim activity show up',
          () => pageElements.activityContents()[0].textContent === 'A quick brown fox\n',
          1_000
        );

        // THEN: Should show the informative message with blue bottom border.
        // THEN: Should not show typing indicator.
        await host.snapshot();

        // WHEN: Final activity arrives.
        await directLine.emulateIncomingActivity({
          channelData: {
            streamId: 't-00001',
            streamSequence: 3,
            streamType: 'final'
          },
          from: {
            id: 'u-00001',
            name: 'Bot',
            role: 'bot'
          },
          id: 't-00003',
          text: 'A quick brown fox jumped over the lazy dogs.',
          type: 'message'
        });

        // THEN: Final activity should appear.
        await pageConditions.numActivitiesShown(1);
        await pageConditions.became(
          'final activity show up',
          () => pageElements.activityContents()[0].textContent === 'A quick brown fox jumped over the lazy dogs.\n',
          1_000
        );

        // THEN: Should show the informative message with blue bottom border.
        // THEN: Should not show typing indicator.
        await host.snapshot();
      });
    </script>
  </body>
</html>
