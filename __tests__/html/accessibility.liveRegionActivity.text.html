<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  </head>
  <body>
    <div id="webchat"></div>
    <script>
      function allTextContents(element) {
        const nodes = [].slice.call(element.childNodes);
        const results = [];

        while (nodes.length) {
          const node = nodes.shift();

          if (node.nodeType === Node.TEXT_NODE) {
            results.push(node.textContent);
          } else {
            nodes.unshift(...[].slice.call(node.childNodes));
          }
        }

        return results;
      }

      run(async function () {
        const timestamp = new Date(2000, 0, 1, 12, 34, 56, 789).toISOString();

        WebChat.renderWebChat(
          {
            directLine: testHelpers.createDirectLineWithTranscript([
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                text: 'Hello, **World** without `speak` property.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: {},
                text: 'Hello, **World** with invalid `speak` property.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: 'Hello, World with speak property in plain text.',
                text: 'Hello, **World** with `speak` property in plain text.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="string">
Hello, World with simple speak property in SSML.
</speak>`,
                text: 'Hello, **World** with simple `speak` property in SSML.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="string">
  <p>
    <s>Hello, <prosody pitch="high">World</prosody> with <say-as interpret-as="spell-out">complex</say-as> speak property in SSML.</s>
  </p>
</speak>`,
                text: 'Hello, **World** with complex `speak` property in SSML.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="string">
  <p>
    <s>今日天氣<prosody pitch="high">很好</prosody>。</s>
  </p>
</speak>`,
                text: 'Hello, **World** with complex `speak` property in SSML.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: 'Say another thing.',
                text: 'Display one thing.',
                textFormat: 'markdown',
                timestamp,
                type: 'message'
              },
              {
                channelData: {
                  messageBack: {
                    displayText: 'Text from MessageBack.'
                  }
                },
                from: { id: 'user', role: 'user' },
                text: 'This should not be displayed.',
                timestamp,
                type: 'message'
              },
              {
                from: {
                  id: 'bot',
                  role: 'bot'
                },
                speak: '',
                text: 'This is presentational, should not narrate.',
                timestamp,
                type: 'message'
              }
            ]),
            store: testHelpers.createStore(),
            styleOptions: {
              internalLiveRegionFadeAfter: 60000
            }
          },
          document.getElementById('webchat')
        );

        await pageConditions.uiConnected();

        const screenReaderTexts = [].map.call(
          document.querySelector('[aria-roledescription="transcript"][role="log"]').children,
          child => allTextContents(child).join('\n')
        );

        expect(screenReaderTexts).toHaveLength(8);

        // Without "speak" property set, we will be narrating the "text" as-is.
        expect(screenReaderTexts[0]).toBe(
          'Bot said:\nHello, **World** without `speak` property.\nSent at January 1 at 12:34 PM'
        );

        // Without "speak" property set, we will be narrating the "text" as-is.
        expect(screenReaderTexts[1]).toBe(
          'Bot said:\nHello, **World** with invalid `speak` property.\nSent at January 1 at 12:34 PM'
        );

        expect(screenReaderTexts[2]).toBe(
          'Bot said:\nHello, World with speak property in plain text.\nSent at January 1 at 12:34 PM'
        );

        expect(screenReaderTexts[3]).toBe(
          'Bot said:\nHello, World with simple speak property in SSML.\nSent at January 1 at 12:34 PM'
        );

        expect(screenReaderTexts[4]).toBe(
          'Bot said:\nHello, World with complex speak property in SSML.\nSent at January 1 at 12:34 PM'
        );

        // Expectation: when we concatenate the text content, we must not add whitespaces. Some languages don't have whitespaces.
        expect(screenReaderTexts[5]).toBe(
          'Bot said:\n今日天氣很好。\nSent at January 1 at 12:34 PM'
        );

        expect(screenReaderTexts[6]).toBe('Bot said:\nSay another thing.\nSent at January 1 at 12:34 PM');
        expect(screenReaderTexts[7]).toBe('You said:\nText from MessageBack.\nSent at January 1 at 12:34 PM');

        // The screenshot should show the message in Markdown format, i.e. <strong> and <code>.
        // It must not show the text "This should not be displayed."
        await host.snapshot();
      });
    </script>
  </body>
</html>
