<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  </head>
  <body>
    <main id="webchat"></main>
    <script>
      run(async function () {
        const directLine = WebChat.createDirectLine({ token: await testHelpers.token.fetchDirectLineToken() });
        const store = testHelpers.createStore();

        WebChat.renderWebChat(
          {
            directLine,
            store: testHelpers.createStore(),
            styleOptions: {
              combineAttachmentsAndText: true
            }
          },
          document.getElementById('webchat')
        );

        await pageConditions.uiConnected();

        // Create a sample file to upload
        const blob = new Blob(['Hello, world!'], { type: 'text/plain' });
        const file = new File([blob], 'File.txt', { type: 'text/plain' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);

        // Upload a file but expect no activities yet
        const uploadButton = pageElements.uploadButton();
        // Add the files to the input and activate the onchange handler
        uploadButton.files = dataTransfer.files;
        uploadButton.dispatchEvent(new Event('change', { bubbles: true }));
        await pageConditions.numActivitiesShown(0);

        // Add message text and send both, expecting 2 activities (1 outgoing and 1 incoming)
        await pageObjects.sendMessageViaSendBox('message', { waitForSend: true });
        await pageConditions.numActivitiesShown(2);

        // Expect outgoing activity to have both text and attachment
        const activities = await pageObjects.getActivities();
        const { text, attachments } = activities.find(({ from: { role } }) => role === 'user');

        expect(text).toBe('message');
        expect(attachments).toHaveLength(1);
        expect(attachments[0].contentType).toBe('text/plain');
        expect(attachments[0].name).toBe('File.txt');
      });
    </script>
  </body>
</html>
