<!DOCTYPE html>
<html lang="en-US">

<head>
  <link href="/assets/index.css" rel="stylesheet" type="text/css" />
  <link href="/assets/accessibility.liveRegionAttachment.css" rel="stylesheet" type="text/css" />
  <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone@7.8.7/babel.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react@16.8.6/umd/react.development.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.development.js"></script>
  <script crossorigin="anonymous" src="/test-harness.js"></script>
  <script crossorigin="anonymous" src="/test-page-object.js"></script>
  <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  <style>
    .decorated-activity {
      border: thick solid red;
    }
  </style>
</head>

<body>
  <main id="webchat"></main>
  <script type="text/babel" data-presets="env,stage-3,react">
    const {
      ReactDOM: { render },
      WebChat: {
        Components: { BasicWebChat, Composer }, v2Middleware
      }
    } = window;

    const NOW = Date.now();

    const DecoratedActivity = ({ children }) => {
      return (<div className="decorated-activity">
        {children}
      </div>)
    }

    const CustomActivity = ({ activity }) => {
      return (<div>
        <h2>{activity.data.heading}</h2>
        <p>{activity.text}</p>
      </div>)
    }

    run(
      async function () {
        await new Promise(resolve =>
          render(
            <Composer
              activityMiddleware={[
                () => next => (...args) => {
                  const [ { activity } ] = args;
                  if (activity.text.includes('decorated')) {
                    const renderActivity = next(...args);
                    if (!renderActivity) return renderActivity;
                    return (...args) => (
                      <DecoratedActivity>
                        {renderActivity.call ? renderActivity(...args) : renderActivity}
                      </DecoratedActivity>
                    );
                  }
                  return next(...args);
                },
                v2Middleware(() => next => props => {
                  const { activity } = props;
                  if (activity.type === 'custom-activity') {
                    return CustomActivity;
                  }
                  return next(props);
                })
              ]}
              directLine={testHelpers.createDirectLineWithTranscript([
                {
                  from: {
                    id: 'bot',
                    role: 'bot'
                  },
                  id: '0',
                  text: 'This is the first message.',
                  timestamp: new Date(NOW).toISOString(),
                  type: 'message'
                },
                {
                  from: {
                    id: 'bot',
                    role: 'bot'
                  },
                  id: '1',
                  text: 'This is the decorated activity.',
                  timestamp: new Date(NOW).toISOString(),
                  type: 'message'
                },
                {
                  from: {
                    id: 'bot',
                    role: 'bot'
                  },
                  id: '2',
                  data: {
                    heading: 'Custom Activity',
                  },
                  text: 'Custom activity text',
                  timestamp: new Date(NOW).toISOString(),
                  type: 'custom-activity'
                },
                {
                  from: {
                    id: 'bot',
                    role: 'bot'
                  },
                  id: '3',
                  data: {
                    heading: 'Custom Activity',
                  },
                  text: 'Custom decorated activity text',
                  timestamp: new Date(NOW).toISOString(),
                  type: 'custom-activity'
                },
              ])}
              store={testHelpers.createStore()}
            >
              <BasicWebChat />
            </Composer>,
            document.getElementById('webchat'),
            resolve
          )
        );

        await pageConditions.uiConnected();
        await host.snapshot();
      },
      { ignoreErrors: true }
    );
  </script>
</body>

</html>