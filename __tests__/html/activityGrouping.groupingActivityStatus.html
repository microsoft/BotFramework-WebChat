<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  </head>
  <body>
    <div id="webchat"></div>
    <script>
      run(async function () {
        await host.windowSize(undefined, 1280, document.getElementById('webchat'));

        const clock = lolex.install();

        const directLine = await testHelpers.createDirectLineWithTranscript([], {
          overridePostActivity: activity => {
            const returnPostActivityDeferred = createDeferred();

            postActivityCallDeferred.resolve({ activity, returnPostActivityDeferred });

            return new Observable(observer => {
              (async function () {
                try {
                  const returnPostActivityValue = await returnPostActivityDeferred.promise;

                  observer.next(await returnPostActivityDeferred.promise);
                  observer.complete();
                } catch (error) {
                  observer.error(error);
                }
              })();
            });
          }
        });

        let postActivityCallDeferred;

        const store = testHelpers.createStore();

        const sendMessage = async text => {
          postActivityCallDeferred = createDeferred();

          store.dispatch({
            type: 'DIRECT_LINE/POST_ACTIVITY',
            meta: { method: 'code' },
            payload: {
              activity: {
                from: {
                  id: 'user',
                  role: 'user'
                },
                text,
                type: 'message'
              }
            }
          });

          const { activity, returnPostActivityDeferred } = await postActivityCallDeferred.promise;

          const id = Math.random().toString(36).substring(2, 7);
          const timestamp = new Date().toISOString();

          return {
            echoBack: updater => {
              let nextActivity = { ...activity, id, timestamp };

              if (updater) {
                nextActivity = updater(nextActivity);
              }

              directLine.activityDeferredObservable.next(nextActivity);
            },
            rejectPostActivity: error => returnPostActivityDeferred.reject(error),
            resolvePostActivity: () => returnPostActivityDeferred.resolve(id)
          };
        };

        WebChat.renderWebChat(
          {
            directLine,
            store,
            styleOptions: {
              groupTimestamp: 60000,
              sendTimeout: 5000
            }
          },
          document.getElementById('webchat')
        );

        await pageConditions.webChatRendered();

        directLine.activityDeferredObservable.next('Ullamco mollit sunt officia consectetur ex commodo.');

        await pageConditions.numActivitiesShown(1);

        directLine.activityDeferredObservable.next(
          'Enim labore laboris Lorem qui exercitation adipisicing labore excepteur commodo reprehenderit velit.'
        );

        await pageConditions.numActivitiesShown(2);

        clock.tick(60001);

        directLine.activityDeferredObservable.next('Anim do voluptate eiusmod nostrud fugiat.');

        await pageConditions.numActivitiesShown(3);

        clock.tick(54000);

        const sendMessage1 = await sendMessage(
          'This will not be grouped initially because the next activity is not sent.'
        );

        sendMessage1.echoBack();
        sendMessage1.resolvePostActivity();

        await pageConditions.numActivitiesShown(4);

        const sendMessage2 = await sendMessage('A retry prompt must show on this activity.');

        await pageConditions.numActivitiesShown(5);

        clock.tick(1000);

        const sendMessage3 = await sendMessage(
          'Do anim irure in laborum qui aliquip dolor officia aliqua do aute exercitation deserunt.'
        );

        sendMessage3.echoBack();
        sendMessage3.resolvePostActivity();

        await pageConditions.numActivitiesShown(6);

        const sendMessage4 = await sendMessage(
          'The timestamp is shown because the next activity is not sent. When it is sent, the timestamp will be hidden.'
        );

        sendMessage4.echoBack();
        sendMessage4.resolvePostActivity();

        await pageConditions.numActivitiesShown(7);

        clock.tick(2000);

        const sendMessage5 = await sendMessage('This activity is being sent.');

        await pageConditions.numActivitiesShown(8);

        clock.tick(4000);
        await host.snapshot();

        clock.tick(1000);
        sendMessage5.echoBack(activity => ({
          ...activity,
          text: 'Nostrud proident nisi dolore deserunt veniam labore labore mollit veniam.'
        }));
        sendMessage5.resolvePostActivity();
        await host.snapshot();

        clock.tick(1000);
        sendMessage2.echoBack(activity => ({
          ...activity,
          text: 'Excepteur culpa culpa ullamco consectetur et dolor excepteur cillum enim nostrud ex do.'
        }));
        sendMessage2.resolvePostActivity();
        await host.snapshot();
      });
    </script>
  </body>
</html>
